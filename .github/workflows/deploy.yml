name: CI/CD Pipeline

on:
  push:
    branches: [ main, preprod ]
  pull_request:
    branches: [ main, preprod ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate:
    name: Validate HTML/CSS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install HTML validator
      run: npm install -g html-validate
      
    - name: Validate HTML files
      run: |
        echo "Validating HTML files..."
        find . -name "*.html" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./backup/*" -exec echo "Checking: {}" \;
        # Create a basic .htmlvalidate.json config
        cat > .htmlvalidate.json << 'EOF'
        {
          "extends": ["html-validate:recommended"],
          "rules": {
            "no-inline-style": "off",
            "require-sri": "off"
          }
        }
        EOF
        find . -name "*.html" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./backup/*" | xargs html-validate || true
        
    - name: Check for broken links
      uses: lycheeverse/lychee-action@v1
      with:
        args: --verbose --no-progress --exclude-path node_modules --exclude-path .git --exclude-path backup './**/*.html' './**/*.md'
        fail: false
        
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for sensitive data
      run: |
        echo "Checking for potential sensitive data..."
        
        # Check for common patterns that shouldn't be in the repo
        if grep -r "password\s*=\s*['\"]" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.github; then
          echo "Warning: Found potential password in code"
        fi
        
        if grep -r "api_key\s*=\s*['\"]" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.github; then
          echo "Warning: Found potential API key in code"
        fi
        
        echo "Security scan completed"
        
  deploy-ready:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify required files
      run: |
        echo "Checking for required deployment files..."
        
        # Check for essential files
        test -f "index.html" || (echo "Error: index.html missing" && exit 1)
        test -f "CNAME" || (echo "Error: CNAME missing" && exit 1)
        test -f "_config.yml" || (echo "Warning: _config.yml missing" && exit 0)
        test -f "README.md" || (echo "Warning: README.md missing" && exit 0)
        
        echo "âœ… All required files present"
        
    - name: Check CSS files
      run: |
        echo "Verifying CSS files..."
        find . -name "*.css" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./backup/*" -exec echo "Found: {}" \;
        
    - name: Check JavaScript files
      run: |
        echo "Verifying JavaScript files..."
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./backup/*" -exec echo "Found: {}" \;

    - name: Check for console.log statements
      run: |
        echo "Checking for console.log statements in source JavaScript..."
        if grep -r "console\.log" . --include="*.js" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=backup; then
          echo "Error: console.log statements found in source JavaScript â€” remove before deploying"
          exit 1
        fi
        echo "âœ… No console.log statements found"
        
    - name: Deployment Ready
      run: |
        echo "ðŸš€ Site is ready for deployment!"
        echo "Domain: $(cat CNAME)"
        echo "Branch: ${GITHUB_REF##*/}"
        echo "Files validated successfully"

  sync-preprod:
    name: Sync main â†’ preprod
    runs-on: ubuntu-latest
    # Only run when pushing directly to main (not on PRs, not from preprod itself)
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    needs: [deploy-ready]

    steps:
    - name: Checkout main
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create or reset preprod branch to HEAD of main
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git checkout -B preprod
        git push origin preprod --force-with-lease || git push origin preprod

        echo "âœ… preprod branch is now in sync with main ($(git rev-parse --short HEAD))"
